.data
ALIGN 16
C_0:
    DB 0b1h, 008h, 05bh, 0dah, 01eh, 0cah, 0dah, 0e9h, 0ebh, 0cbh, 02fh
    DB 081h, 0c0h, 065h, 07ch, 01fh, 02fh, 06ah, 076h, 043h, 02eh, 045h
    DB 0d0h, 016h, 071h, 04eh, 0b8h, 08dh, 075h, 085h, 0c4h, 0fch, 04bh
    DB 07ch, 0e0h, 091h, 092h, 067h, 069h, 001h, 0a2h, 042h, 02ah, 008h
    DB 0a4h, 060h, 0d3h, 015h, 005h, 076h, 074h, 036h, 0cch, 074h, 04dh
    DB 023h, 0ddh, 080h, 065h, 059h, 0f2h, 0a6h, 045h, 007h

C_1:
    DB 06fh, 0a3h, 0b5h, 08ah, 0a9h, 09dh, 02fh, 01ah, 04fh, 0e3h, 09dh
    DB 046h, 00fh, 070h, 0b5h, 0d7h, 0f3h, 0feh, 0eah, 072h, 00ah, 023h
    DB 02bh, 098h, 061h, 0d5h, 05eh, 00fh, 016h, 0b5h, 001h, 031h, 09ah
    DB 0b5h, 017h, 06bh, 012h, 0d6h, 099h, 058h, 05ch, 0b5h, 061h, 0c2h
    DB 0dbh, 00ah, 0a7h, 0cah, 055h, 0ddh, 0a2h, 01bh, 0d7h, 0cbh, 0cdh
    DB 056h, 0e6h, 079h, 004h, 070h, 021h, 0b1h, 09bh, 0b7h

C_2:
    DB 0f5h, 074h, 0dch, 0ach, 02bh, 0ceh, 02fh, 0c7h, 00ah, 039h, 0fch
    DB 028h, 06ah, 03dh, 084h, 035h, 006h, 0f1h, 05eh, 05fh, 052h, 09ch
    DB 01fh, 08bh, 0f2h, 0eah, 075h, 014h, 0b1h, 029h, 07bh, 07bh, 0d3h
    DB 0e2h, 00fh, 0e4h, 090h, 035h, 09eh, 0b1h, 0c1h, 0c9h, 03ah, 037h
    DB 060h, 062h, 0dbh, 009h, 0c2h, 0b6h, 0f4h, 043h, 086h, 07ah, 0dbh
    DB 031h, 099h, 01eh, 096h, 0f5h, 00ah, 0bah, 00ah, 0b2h

C_3:
    DB 0efh, 01fh, 0dfh, 0b3h, 0e8h, 015h, 066h, 0d2h, 0f9h, 048h, 0e1h
    DB 0a0h, 05dh, 071h, 0e4h, 0ddh, 048h, 08eh, 085h, 07eh, 033h, 05ch
    DB 03ch, 07dh, 09dh, 072h, 01ch, 0adh, 068h, 05eh, 035h, 03fh, 0a9h
    DB 0d7h, 02ch, 082h, 0edh, 003h, 0d6h, 075h, 0d8h, 0b7h, 013h, 033h
    DB 093h, 052h, 003h, 0beh, 034h, 053h, 0eah, 0a1h, 093h, 0e8h, 037h
    DB 0f1h, 022h, 00ch, 0beh, 0bch, 084h, 0e3h, 0d1h, 02eh

C_4:
    DB 04bh, 0eah, 06bh, 0ach, 0adh, 047h, 047h, 099h, 09ah, 03fh, 041h
    DB 00ch, 06ch, 0a9h, 023h, 063h, 07fh, 015h, 01ch, 01fh, 016h, 086h
    DB 010h, 04ah, 035h, 09eh, 035h, 0d7h, 080h, 00fh, 0ffh, 0bdh, 0bfh
    DB 0cdh, 017h, 047h, 025h, 03ah, 0f5h, 0a3h, 0dfh, 0ffh, 000h, 0b7h
    DB 023h, 027h, 01ah, 016h, 07ah, 056h, 0a2h, 07eh, 0a9h, 0eah, 063h
    DB 0f5h, 060h, 017h, 058h, 0fdh, 07ch, 06ch, 0feh, 057h

C_5:
    DB 0aeh, 04fh, 0aeh, 0aeh, 01dh, 03ah, 0d3h, 0d9h, 06fh, 0a4h, 0c3h
    DB 03bh, 07ah, 030h, 039h, 0c0h, 02dh, 066h, 0c4h, 0f9h, 051h, 042h
    DB 0a4h, 06ch, 018h, 07fh, 09ah, 0b4h, 09ah, 0f0h, 08eh, 0c6h, 0cfh
    DB 0fah, 0a6h, 0b7h, 01ch, 09ah, 0b7h, 0b4h, 00ah, 0f2h, 01fh, 066h
    DB 0c2h, 0beh, 0c6h, 0b6h, 0bfh, 071h, 0c5h, 072h, 036h, 090h, 04fh
    DB 035h, 0fah, 068h, 040h, 07ah, 046h, 064h, 07dh, 06eh

C_6:
    DB 0f4h, 0c7h, 00eh, 016h, 0eeh, 0aah, 0c5h, 0ech, 051h, 0ach, 086h
    DB 0feh, 0bfh, 024h, 009h, 054h, 039h, 09eh, 0c6h, 0c7h, 0e6h, 0bfh
    DB 087h, 0c9h, 0d3h, 047h, 03eh, 033h, 019h, 07ah, 093h, 0c9h, 009h
    DB 092h, 0abh, 0c5h, 02dh, 082h, 02ch, 037h, 006h, 047h, 069h, 083h
    DB 028h, 04ah, 005h, 004h, 035h, 017h, 045h, 04ch, 0a2h, 03ch, 04ah
    DB 0f3h, 088h, 086h, 056h, 04dh, 03ah, 014h, 0d4h, 093h

C_7:
    DB 09bh, 01fh, 05bh, 042h, 04dh, 093h, 0c9h, 0a7h, 003h, 0e7h, 0aah
    DB 002h, 00ch, 06eh, 041h, 041h, 04eh, 0b7h, 0f8h, 071h, 09ch, 036h
    DB 0deh, 01eh, 089h, 0b4h, 044h, 03bh, 04dh, 0dbh, 0c4h, 09ah, 0f4h
    DB 089h, 02bh, 0cbh, 092h, 09bh, 006h, 090h, 069h, 0d1h, 08dh, 02bh
    DB 0d1h, 0a5h, 0c4h, 02fh, 036h, 0ach, 0c2h, 035h, 059h, 051h, 0a8h
    DB 0d9h, 0a4h, 07fh, 00dh, 0d4h, 0bfh, 002h, 0e7h, 01eh

C_8:
    DB 037h, 08fh, 05ah, 054h, 016h, 031h, 022h, 09bh, 094h, 04ch, 09ah
    DB 0d8h, 0ech, 016h, 05fh, 0deh, 03ah, 07dh, 03ah, 01bh, 025h, 089h
    DB 042h, 024h, 03ch, 0d9h, 055h, 0b7h, 0e0h, 00dh, 009h, 084h, 080h
    DB 00ah, 044h, 00bh, 0dbh, 0b2h, 0ceh, 0b1h, 07bh, 02bh, 08ah, 09ah
    DB 0a6h, 007h, 09ch, 054h, 00eh, 038h, 0dch, 092h, 0cbh, 01fh, 02ah
    DB 060h, 072h, 061h, 044h, 051h, 083h, 023h, 05ah, 0dbh

C_9:
    DB 0abh, 0beh, 0deh, 0a6h, 080h, 005h, 06fh, 052h, 038h, 02ah, 0e5h
    DB 048h, 0b2h, 0e4h, 0f3h, 0f3h, 089h, 041h, 0e7h, 01ch, 0ffh, 08ah
    DB 078h, 0dbh, 01fh, 0ffh, 0e1h, 08ah, 01bh, 033h, 061h, 003h, 09fh
    DB 0e7h, 067h, 002h, 0afh, 069h, 033h, 04bh, 07ah, 01eh, 06ch, 030h
    DB 03bh, 076h, 052h, 0f4h, 036h, 098h, 0fah, 0d1h, 015h, 03bh, 0b6h
    DB 0c3h, 074h, 0b4h, 0c7h, 0fbh, 098h, 045h, 09ch, 0edh

C_10:
    DB 07bh, 0cdh, 09eh, 0d0h, 0efh, 0c8h, 089h, 0fbh, 030h, 002h, 0c6h
    DB 0cdh, 063h, 05ah, 0feh, 094h, 0d8h, 0fah, 06bh, 0bbh, 0ebh, 0abh
    DB 007h, 061h, 020h, 001h, 080h, 021h, 014h, 084h, 066h, 079h, 08ah
    DB 01dh, 071h, 0efh, 0eah, 048h, 0b9h, 0cah, 0efh, 0bah, 0cdh, 01dh
    DB 07dh, 047h, 06eh, 098h, 0deh, 0a2h, 059h, 04ah, 0c0h, 06fh, 0d8h
    DB 05dh, 06bh, 0cah, 0a4h, 0cdh, 081h, 0f3h, 02dh, 01bh

C_11:
    DB 037h, 08eh, 0e7h, 067h, 0f1h, 016h, 031h, 0bah, 0d2h, 013h, 080h
    DB 0b0h, 004h, 049h, 0b1h, 07ah, 0cdh, 0a4h, 03ch, 032h, 0bch, 0dfh
    DB 01dh, 077h, 0f8h, 020h, 012h, 0d4h, 030h, 021h, 09fh, 09bh, 05dh
    DB 080h, 0efh, 09dh, 018h, 091h, 0cch, 086h, 0e7h, 01dh, 0a4h, 0aah
    DB 088h, 0e1h, 028h, 052h, 0fah, 0f4h, 017h, 0d5h, 0d9h, 0b2h, 01bh
    DB 099h, 048h, 0bch, 092h, 04ah, 0f1h, 01bh, 0d7h, 020h


C_TABLE:
    QWORD C_0
    QWORD C_1
    QWORD C_2
    QWORD C_3
    QWORD C_4
    QWORD C_5
    QWORD C_6
    QWORD C_7
    QWORD C_8
    QWORD C_9
    QWORD C_10
    QWORD C_11

.code


EXTERN streebog_xor_512:PROC
EXTERN streebog_s_transform:PROC
EXTERN streebog_p_transform:PROC
EXTERN streebog_l_transform:PROC

streebog_key_schedule PROC
    
    push rbx
    push rsi
    push r12
    push r13
    
    sub rsp, 40         

    mov rsi, rcx        
    mov r12d, edx       
    mov r13, r8         
    
    
    lea rbx, [C_TABLE]
    movsxd rax, r12d
    mov rbx, QWORD PTR [rbx + rax*8]  
    
    mov rcx, rsi        
    mov rdx, rbx        
    mov r8, r13         
    call streebog_xor_512
    
    mov rcx, r13        
    mov rdx, r13        
    call streebog_s_transform
    
    mov rcx, r13        
    mov rdx, r13        
    call streebog_p_transform
    
    mov rcx, r13        
    mov rdx, r13        
    call streebog_l_transform
    
    add rsp, 40
    pop r13
    pop r12
    pop rsi
    pop rbx
    ret
streebog_key_schedule ENDP
END